<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>title</title>
    <div th:include="fragment/head :: head"></div>
</head>
<body>
<form class="layui-form where" method="post" id="search">
    <div class="layui-inline">
        <label class="layui-form-label">姓名：</label>
        <div class="layui-input-inline" style="width: 100px;">
            <input name="name" type="text" class="layui-input"/>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">手机：</label>
        <div class="layui-input-inline" style="width: 100px;">
            <input name="customerPhoneNumber" type="text" class="layui-input"/>
        </div>
    </div>
    <div th:substituteby="fragment/city_select :: province"></div>
    <div th:substituteby="fragment/city_select :: city"></div>
    <div th:substituteby="fragment/city_select :: area"></div>
    <input type="hidden" th:value="${session.staff.loginName}" name="staffId"/>
    <input name="customerAddress" type="hidden"/>
    <button class="layui-btn layui-btn-sm" lay-submit="lay-submit" lay-filter="search">查询</button>
</form>
<table id="cases" lay-filter="cases"></table>


<script type="text/html" id="urge">
    <a class="layui-btn  layui-btn-xs" lay-event="urge">催记</a>
    <!--<a class="layui-btn  layui-btn-xs" lay-event="end">结案</a>-->
</script>
<script type="text/html" id="status">
    {{#  if(d.status === 3){ }}
    结案
    {{#  } }}
    {{#  if(d.status === 0){ }}
    正常
    {{#  } }}
    {{#  if(d.status === 2){ }}
    {{# }}
    留案
    {{#  } }}
    {{#  if(d.status === 1){ }}
    撤案
    {{#  } }}
</script>

<script th:src="@{/static/layui/layui.js}"></script>
</body>
<div style="display: none;" id="reason">
    <textarea id="endReason" lay-verify="required" placeholder="结案原因" class="layui-textarea"></textarea>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/

    layui.use(['table','form','laytpl'], function () {
        var table = layui.table
            , $ = layui.$
            , form = layui.form
            ,laytpl = layui.laytpl;
        var cases = table.render({
            elem: '#cases'
            , id: 'cases'
            , height:'full-60'
            , url: [[${ctx}]] + '/case/list/bystaff' //数据接口
            , page: true //开启分页
            , where: {staff: JSON.stringify(JSON.parse('{"staffId":"'+[[${session.staff.loginName}]]+'"}'))}
            , method: 'post'
            , cols: [[ //表头
                {field: 'name', title: '姓名', width:'10%', sort: true}
                , {field: 'customerPhoneNumber', title: '手机', width: '10%', sort: true}
                , {field: 'customerAddress', title: '户籍', width: '14%', sort: true}
                , {field: 'loanPrincipal', title: '贷款本金', width: '10%', sort: true}
                , {field: 'repaymentMoney', title: '已还金额', width: '10%', sort: true}
                , {field: 'overrangingDay', title: '逾期天数', width: '10%', sort: true}
                , {field: 'sumArrears', title: '总欠款', width: '10%', sort: true}
                , {field: 'lastUrge', title: '最后一次催记时间', width: '10%', sort: true}
                , {field: 'status', title: '状态', width: '6%',templet:'#status'}
                , {fixed: 'urge', title: '分配', width: '10%', align: 'center', toolbar: '#urge',fixed:'right'}
            ]]
            ,done: function(res, curr, count){

                layui.$('table tbody tr ').each(function () {
                    if ($(this).children().eq(8).text().trim() == '撤案') {
                        $(this).css('background-color', '#FF5722');
                        $(this).css('color', '#FFB90F');
                    }
                    if ($(this).children().eq(8).text().trim() == '留案') {
                        $(this).css('background-color', '#5FB878');
                        $(this).css('color', '#FFB800');
                    }
                    if ($(this).children().eq(8).text().trim() == '结案') {
                        $(this).css('background-color', '#36b811');
                        $(this).css('color', '#ffd98c');
                    }
                })

            }
        });
        table.on('tool(cases)', function (obj) {
            if(obj.data.status===1){
                layer.msg("委案已经撤回");
                return;
            }
            if(obj.data.status===3){
                layer.msg("委案已经结案");
                return;
            }
/*            其他联系人 customerOtherPhone  姓名 customerRelativeOther 关系 customerRelaOther
            本人 customerPhoneNumber
            亲戚 customerRelativePhone 姓名 customerRelativeName 关系 customerRelationship
            住宅 customerResidencePhone
             配偶 customerSpousePhone 姓名 customerSpouse*/
            if(obj.event==='urge'){
                var addurge=layer.open({
                    type: 2
                    , title: '添加催记'
                   , shade: 0
                    , content:"add?cases="+obj.data.id
                    ,cancel: function(index, layero){
                        cases.reload();
                    }
                    });
                layer.full(addurge);
            }else if(obj.event==='end'){
                layer.open({
                    type: 1
                    , title: '留案'
                    , area: ['500px', '220px']
                    , content: $("#reason")
                    , btn: ['添加', '取消']
                    , yes: function (index, layero) {
                        obj.data.endReason=$("#endReason").val();
                        obj.data.status=3;
                        console.log(obj.data)
                        var casess=new Array();
                        casess.push(obj.data);
                        $.ajax({
                            url: [[${ctx}]] + "/case/manager",
                            type: "post",
                            dataType: 'json',
                            data: {cases:JSON.stringify(casess)},
                            success: function (data) {
                                layer.msg(data.message);
                                cases.reload();
                            }
                        });
                    }
                })
            }
        });

        form.on('submit(search)', function (data) {
            cases.reload({page: {curr: 1 },where:{staff:JSON.stringify(data.field)}});
            return false;
        });
        layui.config({
            base: [[${ctx}]]+'/static/layui/js/'
        }).use('cityselect');

    })
    /*]]>*/
</script>
</html>